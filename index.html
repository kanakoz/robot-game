<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É≠„Éú„Éª„Éê„Éà„É©„Éº„Ç∫ÔºÅ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LIFF SDK„ÇíËøΩÂä† -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #0f172a;
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(76, 29, 149, 0.2) 0%, rgba(15, 23, 42, 0) 50%),
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 20px 20px, 20px 20px;
            color: white;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .title-font {
            font-family: 'Mochiy Pop One', sans-serif;
        }

        /* SVG Glow Filter */
        .neon-glow {
            filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.7)) 
                    drop-shadow(0 0 5px currentColor);
        }

        .robot-container {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake {
            animation: shake 0.5s;
        }

        @keyframes dodge-move {
            0% { transform: translateX(0); }
            25% { transform: translateX(-50px) skewX(10deg); }
            50% { transform: translateX(-50px) skewX(10deg); }
            100% { transform: translateX(0); }
        }
        .dodge-anim {
            animation: dodge-move 0.5s ease-out;
        }

        @keyframes attack-thrust {
            0% { transform: translateX(0); }
            20% { transform: translateX(-20px) scale(0.9); }
            50% { transform: translateX(100px) scale(1.1); }
            100% { transform: translateX(0); }
        }
        .attack-anim {
            animation: attack-thrust 0.4s ease-in-out;
        }
        
        @keyframes enemy-attack-thrust {
            0% { transform: translateX(0) scaleX(-1); }
            20% { transform: translateX(20px) scaleX(-1) scale(0.9); }
            50% { transform: translateX(-100px) scaleX(-1) scale(1.1); }
            100% { transform: translateX(0) scaleX(-1); }
        }
        .enemy-attack-anim {
            animation: enemy-attack-thrust 0.4s ease-in-out;
        }

        @keyframes damage-text {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }
        .damage-popup {
            position: absolute;
            font-weight: 900;
            font-size: 2rem;
            color: #ff0055;
            text-shadow: 2px 2px 0 #fff;
            pointer-events: none;
            animation: damage-text 1s forwards;
            z-index: 50;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        /* Scrollbar hiding */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .stat-bar-fill {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Timing Game Styles */
        #timing-bar-container {
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        #timing-cursor {
            will-change: left;
        }
        @keyframes cursor-move {
            0% { left: 0%; }
            100% { left: 100%; }
        }
        .cursor-running {
            animation: cursor-move 1s linear infinite alternate;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Game Container -->
    <div id="game-app" class="w-full max-w-4xl aspect-[9/16] md:aspect-auto md:h-[90vh] relative overflow-hidden rounded-3xl shadow-2xl border-4 border-indigo-500/50 bg-slate-900">
        
        <!-- Background Grid Effect (Pseudo-3D) -->
        <div class="absolute inset-0 opacity-20 pointer-events-none">
            <div class="absolute bottom-0 w-full h-1/2 bg-gradient-to-t from-indigo-900 to-transparent"></div>
        </div>

        <!-- TITLE SCREEN -->
        <div id="screen-title" class="absolute inset-0 flex flex-col items-center justify-center z-20 transition-opacity duration-500">
            <h1 class="title-font text-6xl md:text-7xl text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-pink-500 to-cyan-400 mb-8 text-center drop-shadow-lg animate-float">
                „É≠„Éú„Éª„Éê„Éà„É©„Éº„Ç∫
            </h1>
            <div class="robot-preview w-48 h-48 mb-8 animate-float" id="title-robot">
                <!-- Dynamic SVG will be inserted here -->
            </div>
            <button onclick="game.goToBuild()" class="group relative px-8 py-4 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full font-bold text-2xl text-white shadow-lg hover:scale-105 transition-all duration-200 overflow-hidden">
                <span class="relative z-10">„Ç≤„Éº„É†„Çπ„Çø„Éº„ÉàÔºÅ</span>
                <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
            </button>
        </div>

        <!-- BUILD SCREEN -->
        <div id="screen-build" class="hidden absolute inset-0 flex flex-col z-10 bg-slate-900/90">
            <!-- Header -->
            <div class="p-4 bg-slate-800/80 backdrop-blur-md border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-cyan-300 title-font">„É≠„Éú„ÉÉ„ÉàÂ∑•Â†¥</h2>
                <div class="flex gap-2 text-sm font-bold bg-black/40 p-2 rounded-lg">
                    <span class="text-pink-400">HP: <span id="stat-hp-val">0</span></span>
                    <span class="text-yellow-400">ATK: <span id="stat-atk-val">0</span></span>
                    <span class="text-green-400">SPD: <span id="stat-spd-val">0</span></span>
                </div>
            </div>

            <!-- Main Build Area -->
            <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
                <!-- Robot Preview -->
                <div class="flex-1 relative bg-gradient-to-b from-slate-800 to-slate-900 flex items-center justify-center p-4">
                    <div class="absolute top-4 left-4 text-slate-500 text-sm">PREVIEW</div>
                    <div id="build-preview" class="w-64 h-64 md:w-80 md:h-80 filter drop-shadow-[0_0_15px_rgba(56,189,248,0.3)] transition-all duration-300">
                        <!-- Robot SVG -->
                    </div>
                </div>

                <!-- Parts Selection -->
                <div class="h-1/3 md:h-full md:w-96 bg-slate-900 border-t md:border-t-0 md:border-l border-slate-700 flex flex-col">
                    <!-- Tabs -->
                    <div class="flex border-b border-slate-700">
                        <button onclick="game.setTab('head')" class="tab-btn flex-1 py-3 text-center font-bold hover:bg-slate-800 transition text-cyan-400 border-b-2 border-cyan-400" data-tab="head">„Ç¢„Çø„Éû</button>
                        <button onclick="game.setTab('body')" class="tab-btn flex-1 py-3 text-center font-bold hover:bg-slate-800 transition text-slate-400" data-tab="body">„Éú„Éá„Ç£</button>
                        <button onclick="game.setTab('arms')" class="tab-btn flex-1 py-3 text-center font-bold hover:bg-slate-800 transition text-slate-400" data-tab="arms">„Ç¶„Éá</button>
                        <button onclick="game.setTab('legs')" class="tab-btn flex-1 py-3 text-center font-bold hover:bg-slate-800 transition text-slate-400" data-tab="legs">„Ç¢„Ç∑</button>
                    </div>
                    
                    <!-- Parts Grid -->
                    <div id="parts-grid" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-3 hide-scrollbar content-start">
                        <!-- Generated by JS -->
                    </div>

                    <!-- Action Button -->
                    <div class="p-4 border-t border-slate-700 bg-slate-800">
                        <button onclick="game.startBattle()" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl font-bold text-xl text-white shadow-lg hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2">
                            <span>„Éê„Éà„É´„Å∏ GO!</span>
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- BATTLE SCREEN -->
        <div id="screen-battle" class="hidden absolute inset-0 bg-slate-900 z-10 flex flex-col">
            <!-- Battle HUD -->
            <div class="h-24 bg-slate-900/80 flex justify-between items-center px-4 border-b border-slate-700 relative z-20">
                <!-- Player Stats -->
                <div class="w-1/3">
                    <div class="text-cyan-400 font-bold mb-1 text-sm md:text-base">„ÅÇ„Å™„Åü</div>
                    <div class="h-4 bg-slate-700 rounded-full overflow-hidden border border-slate-600 relative">
                        <div id="battle-hp-player" class="h-full bg-gradient-to-r from-green-400 to-green-600 stat-bar-fill" style="width: 100%"></div>
                    </div>
                    <div class="text-right text-xs text-slate-400 mt-1"><span id="hp-text-player">100</span> HP</div>
                </div>

                <!-- VS Badge -->
                <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2">
                    <div class="w-12 h-12 rounded-full bg-red-600 flex items-center justify-center font-black italic text-white border-4 border-slate-900 shadow-lg text-xl">VS</div>
                </div>

                <!-- Enemy Stats -->
                <div class="w-1/3 text-right">
                    <div class="text-red-400 font-bold mb-1 text-sm md:text-base">„É©„Ç§„Éê„É´</div>
                    <div class="h-4 bg-slate-700 rounded-full overflow-hidden border border-slate-600 relative">
                        <div id="battle-hp-enemy" class="h-full bg-gradient-to-r from-red-400 to-orange-600 stat-bar-fill" style="width: 100%"></div>
                    </div>
                    <div class="text-left text-xs text-slate-400 mt-1"><span id="hp-text-enemy">100</span> HP</div>
                </div>
            </div>

            <!-- Battle Arena -->
            <div class="flex-1 relative overflow-hidden bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCI+CjxwYXRoIGQ9Ik0wIDBoNDB2NDBIMHoiIGZpbGw9IiMwZjE3MmEiLz4KPHBhdGggZD0iTTAgNDBMMzggMm0yIDM4TDIsIiBzdHJva2U9IiMxZTI5M2IiIHN0cm9rZS13aWR0aD0iMSIvPgo8L3N2Zz4=')]">
                <!-- Robots -->
                <div class="absolute inset-0 flex items-center justify-center gap-8 md:gap-32 px-4">
                    <!-- Player -->
                    <div id="battle-player-pos" class="relative w-40 h-40 md:w-64 md:h-64 transition-transform duration-500">
                        <div id="battle-player-robot" class="w-full h-full drop-shadow-2xl"></div>
                        <div class="absolute -bottom-8 left-1/2 -translate-x-1/2 w-24 h-6 bg-black/30 rounded-[50%] blur-md"></div>
                    </div>
                    
                    <!-- Enemy -->
                    <div id="battle-enemy-pos" class="relative w-40 h-40 md:w-64 md:h-64 transition-transform duration-500 transform scale-x-[-1]">
                        <div id="battle-enemy-robot" class="w-full h-full drop-shadow-2xl filter hue-rotate-180"></div>
                        <div class="absolute -bottom-8 left-1/2 -translate-x-1/2 w-24 h-6 bg-black/30 rounded-[50%] blur-md"></div>
                    </div>
                </div>

                <!-- Log Overlay -->
                <div id="battle-log" class="absolute top-4 left-1/2 -translate-x-1/2 bg-black/60 backdrop-blur px-6 py-2 rounded-full text-white font-bold text-sm md:text-lg whitespace-nowrap opacity-0 transition-opacity text-center z-30">
                    „Éê„Éà„É´ÈñãÂßãÔºÅ
                </div>

                <!-- TIMING GAME OVERLAY -->
                <div id="timing-overlay" class="absolute inset-0 z-40 bg-black/50 flex flex-col items-center justify-center hidden">
                    <div class="text-white text-2xl font-bold mb-4 animate-bounce title-font text-shadow">„Çø„Ç§„Éü„É≥„Ç∞„Çí„ÅÇ„Çè„Åõ„ÇçÔºÅ</div>
                    <div id="timing-bar-container" class="relative w-64 h-8 bg-slate-700 rounded-full border-4 border-white overflow-hidden">
                        <!-- Zone: Critical -->
                        <div id="timing-zone-crit" class="absolute top-0 bottom-0 bg-yellow-400/80 left-1/2 -translate-x-1/2 w-6 z-10 shadow-[0_0_10px_#fbbf24]"></div>
                        <!-- Zone: Normal -->
                        <div class="absolute top-0 bottom-0 bg-blue-500/50 left-1/4 right-1/4 z-0"></div>
                        <!-- Cursor -->
                        <div id="timing-cursor" class="absolute top-0 bottom-0 w-2 bg-red-600 z-20 shadow-[0_0_5px_red]"></div>
                    </div>
                    <button onclick="game.resolveTimingAttack()" class="mt-8 w-32 h-32 rounded-full bg-red-600 border-4 border-red-400 shadow-[0_0_20px_red] text-white font-black text-2xl active:scale-95 transition-transform">
                        STOP!
                    </button>
                </div>
            </div>

            <!-- Controls -->
            <div class="h-1/4 bg-slate-800 border-t border-slate-700 p-4 grid grid-cols-3 gap-4">
                <button onclick="game.initiateAttack()" class="battle-btn bg-gradient-to-b from-red-500 to-red-700 text-white rounded-xl border-b-4 border-red-900 font-bold text-lg shadow-lg active:border-b-0 active:translate-y-1 transition-all group">
                    <div class="text-2xl mb-1">‚öîÔ∏è</div>
                    „Ç¢„Çø„ÉÉ„ÇØ
                </button>
                <button onclick="game.playerAction('special')" class="battle-btn bg-gradient-to-b from-yellow-400 to-orange-600 text-white rounded-xl border-b-4 border-orange-800 font-bold text-lg shadow-lg active:border-b-0 active:translate-y-1 transition-all disabled:opacity-50 disabled:grayscale" id="btn-special">
                    <div class="text-2xl mb-1">‚ö°</div>
                    ÂøÖÊÆ∫ÊäÄ
                    <div class="text-xs font-normal opacity-80">(„ÉÅ„É£„Éº„Ç∏: <span id="special-charge">0</span>/3)</div>
                </button>
                <button onclick="game.playerAction('repair')" class="battle-btn bg-gradient-to-b from-green-400 to-teal-600 text-white rounded-xl border-b-4 border-teal-800 font-bold text-lg shadow-lg active:border-b-0 active:translate-y-1 transition-all">
                    <div class="text-2xl mb-1">üîß</div>
                    „Åó„ÇÖ„ÅÜ„Çä
                </button>
            </div>
        </div>

        <!-- RESULT OVERLAY -->
        <div id="screen-result" class="hidden absolute inset-0 z-50 bg-black/80 flex flex-col items-center justify-center backdrop-blur-sm">
            <h2 id="result-title" class="text-6xl font-black text-white mb-4 title-font drop-shadow-[0_0_10px_rgba(255,255,255,0.8)]">YOU WIN!</h2>
            <div id="result-message" class="text-xl text-slate-300 mb-8 font-bold">Êïµ„É≠„Éú„ÉÉ„Éà„ÇíÊíÉÁ†¥„Åó„ÅüÔºÅ</div>
            <button onclick="game.resetGame()" class="px-8 py-3 bg-white text-indigo-900 font-bold text-xl rounded-full shadow-[0_0_20px_rgba(255,255,255,0.5)] hover:scale-110 transition-transform">
                „ÇÇ„ÅÜ„ÅÑ„Å°„Å©ÈÅä„Å∂
            </button>
        </div>

    </div>

    <script>
        // --- DATA & CONFIG ---

        const COLORS = {
            red: '#ef4444',
            blue: '#3b82f6',
            green: '#22c55e',
            yellow: '#eab308',
            purple: '#a855f7',
            cyan: '#06b6d4',
            pink: '#ec4899',
            slate: '#64748b'
        };

        const PARTS = {
            head: [
                { id: 'h1', name: '„Çπ„Çø„É≥„ÉÄ„Éº„Éâ', hp: 20, atk: 5, spd: 5, color: 'blue', type: 'standard' },
                { id: 'h2', name: '„Éã„É≥„Ç∏„É£', hp: 10, atk: 8, spd: 15, color: 'purple', type: 'ninja' },
                { id: 'h3', name: '„Çø„É≥„ÇØ', hp: 40, atk: 3, spd: 2, color: 'green', type: 'tank' },
                { id: 'h4', name: '„Ç≥„Éû„É≥„ÉÄ„Éº', hp: 25, atk: 10, spd: 8, color: 'red', type: 'commander' },
            ],
            body: [
                { id: 'b1', name: '„Ç≥„Ç¢MK-1', hp: 50, atk: 5, spd: 5, color: 'blue', type: 'core' },
                { id: 'b2', name: '„É©„Ç§„Éà„Ç¢„Éº„Éû„Éº', hp: 30, atk: 10, spd: 15, color: 'yellow', type: 'light' },
                { id: 'b3', name: '„Éò„Éì„Éº„É°„Çø„É´', hp: 80, atk: 5, spd: 0, color: 'slate', type: 'heavy' },
                { id: 'b4', name: '„É™„Ç¢„ÇØ„Çø„Éº', hp: 40, atk: 20, spd: 5, color: 'cyan', type: 'reactor' },
            ],
            arms: [
                { id: 'a1', name: '„Éû„Éã„Éî„É•„É¨„Éº„Çø', hp: 10, atk: 15, spd: 5, color: 'blue', type: 'basic' },
                { id: 'a2', name: '„Éâ„É™„É´', hp: 15, atk: 25, spd: 2, color: 'yellow', type: 'drill' },
                { id: 'a3', name: '„É¨„Éº„Ç∂„Éº', hp: 5, atk: 30, spd: 8, color: 'pink', type: 'laser' },
                { id: 'a4', name: '„Ç∑„Éº„É´„Éâ', hp: 30, atk: 5, spd: 5, color: 'green', type: 'shield' },
            ],
            legs: [
                { id: 'l1', name: '‰∫åË∂≥Ê≠©Ë°å', hp: 20, atk: 5, spd: 10, color: 'blue', type: 'biped' },
                { id: 'l2', name: '„Ç≠„É£„Çø„Éî„É©', hp: 40, atk: 5, spd: 2, color: 'slate', type: 'tracks' },
                { id: 'l3', name: '„Éõ„Éê„Éº', hp: 10, atk: 5, spd: 25, color: 'cyan', type: 'hover' },
                { id: 'l4', name: '„Çπ„Éë„Ç§„ÉÄ„Éº', hp: 25, atk: 10, spd: 15, color: 'purple', type: 'spider' },
            ]
        };

        // --- RENDER LOGIC (SVG Construction) ---
        
        function getPartSVG(type, styleType, colorKey) {
            const c = COLORS[colorKey] || COLORS.blue;
            const cDark = adjustColor(c, -40);
            const cLight = adjustColor(c, 40);

            const paths = {
                head: {
                    standard: `<rect x="75" y="20" width="50" height="40" rx="5" fill="${c}" stroke="${cDark}" stroke-width="2"/><rect x="80" y="30" width="40" height="10" fill="#1e293b"/><circle cx="90" cy="35" r="3" fill="#00ffcc" class="neon-glow"/><circle cx="110" cy="35" r="3" fill="#00ffcc" class="neon-glow"/><path d="M73 25 L75 40 L70 40 Z" fill="${cDark}"/>`,
                    ninja: `<path d="M100 15 L75 30 L80 60 L100 65 L120 60 L125 30 Z" fill="${c}" stroke="${cDark}" stroke-width="2"/><path d="M80 35 L120 35 L115 45 L85 45 Z" fill="#111"/><circle cx="100" cy="40" r="4" fill="#ff0055" class="neon-glow"/>`,
                    tank: `<path d="M70 20 H130 V50 H70 Z" fill="${c}" rx="5"/><rect x="75" y="30" width="50" height="10" fill="#334155"/><rect x="85" y="32" width="30" height="6" fill="#ef4444" class="neon-glow"/>`,
                    commander: `<path d="M80 15 L120 15 L115 60 L85 60 Z" fill="${c}"/><path d="M95 10 L105 10 L105 20 L95 20 Z" fill="#fbbf24"/><circle cx="100" cy="35" r="8" fill="#22d3ee" class="neon-glow"/>`
                },
                body: {
                    core: `<rect x="60" y="60" width="80" height="70" rx="10" fill="${c}" stroke="${cDark}" stroke-width="3"/><circle cx="100" cy="95" r="15" fill="#fff" opacity="0.5"/><circle cx="100" cy="95" r="10" fill="${cDark}"/><circle cx="100" cy="95" r="5" fill="#fbbf24" class="neon-glow"/>`,
                    light: `<path d="M70 60 L130 60 L120 120 L80 120 Z" fill="${c}" stroke="${cDark}" stroke-width="2"/><path d="M90 70 H110 V90 H90 Z" fill="#333"/><path d="M92 72 H108 V88 H92 Z" fill="#00ffcc" opacity="0.8"/>`,
                    heavy: `<rect x="50" y="60" width="100" height="80" rx="5" fill="${c}" stroke="${cDark}" stroke-width="4"/><line x1="50" y1="80" x2="150" y2="80" stroke="${cDark}" stroke-width="2"/><line x1="50" y1="110" x2="150" y2="110" stroke="${cDark}" stroke-width="2"/>`,
                    reactor: `<circle cx="100" cy="95" r="40" fill="${c}" stroke="${cDark}" stroke-width="2"/><circle cx="100" cy="95" r="20" fill="#fff"/><path d="M100 75 L100 115 M80 95 L120 95" stroke="${c}" stroke-width="5" class="neon-glow"/>`
                },
                arms: {
                    basic: `<rect x="30" y="70" width="30" height="60" rx="5" fill="${c}" stroke="${cDark}" stroke-width="2"/><rect x="140" y="70" width="30" height="60" rx="5" fill="${c}" stroke="${cDark}" stroke-width="2"/><circle cx="45" cy="140" r="10" fill="#333"/><circle cx="155" cy="140" r="10" fill="#333"/>`,
                    drill: `<path d="M30 70 L60 70 L55 100 L35 100 Z" fill="${c}"/><path d="M45 100 L30 150 L60 150 Z" fill="#cbd5e1"/><path d="M30 150 L45 180 L60 150" fill="#94a3b8"/><rect x="140" y="70" width="30" height="40" fill="${c}"/><path d="M155 110 L140 160 L170 160 Z" fill="#cbd5e1"/><path d="M140 160 L155 190 L170 160" fill="#94a3b8"/>`,
                    laser: `<rect x="35" y="70" width="20" height="50" fill="${c}"/><rect x="30" y="120" width="30" height="10" fill="#333"/><rect x="35" y="130" width="20" height="30" fill="#ef4444" class="neon-glow"/><rect x="145" y="70" width="20" height="50" fill="${c}"/><rect x="140" y="120" width="30" height="10" fill="#333"/><rect x="145" y="130" width="20" height="30" fill="#ef4444" class="neon-glow"/>`,
                    shield: `<rect x="40" y="70" width="20" height="40" fill="${c}"/><path d="M10 70 H40 V140 C40 150 25 160 10 140 Z" fill="${cDark}" stroke="#fff" stroke-width="2"/><rect x="140" y="70" width="20" height="40" fill="${c}"/><path d="M190 70 H160 V140 C160 150 175 160 190 140 Z" fill="${cDark}" stroke="#fff" stroke-width="2"/>`
                },
                legs: {
                    biped: `<rect x="65" y="130" width="25" height="60" rx="5" fill="${c}" stroke="${cDark}" stroke-width="2"/><rect x="110" y="130" width="25" height="60" rx="5" fill="${c}" stroke="${cDark}" stroke-width="2"/><rect x="60" y="190" width="35" height="15" fill="${cDark}"/><rect x="105" y="190" width="35" height="15" fill="${cDark}"/>`,
                    tracks: `<path d="M50 140 H150 V180 H50 Z" fill="#333"/><circle cx="65" cy="180" r="10" fill="#555"/><circle cx="100" cy="180" r="10" fill="#555"/><circle cx="135" cy="180" r="10" fill="#555"/><rect x="50" y="130" width="100" height="20" fill="${c}"/>`,
                    hover: `<path d="M70 140 H130 L140 180 H60 Z" fill="${c}"/><ellipse cx="100" cy="190" rx="50" ry="10" fill="#22d3ee" opacity="0.6" class="neon-glow"/><ellipse cx="100" cy="190" rx="30" ry="5" fill="#fff" opacity="0.8"/>`,
                    spider: `<path d="M60 130 Q40 150 20 190" stroke="${c}" stroke-width="8" fill="none"/><path d="M140 130 Q160 150 180 190" stroke="${c}" stroke-width="8" fill="none"/><path d="M80 130 Q70 160 60 190" stroke="${c}" stroke-width="8" fill="none"/><path d="M120 130 Q130 160 140 190" stroke="${c}" stroke-width="8" fill="none"/>`
                }
            };

            return paths[type][styleType] || '';
        }

        function renderRobotSVG(parts) {
            let svgContent = `
                <svg viewBox="0 0 200 250" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                            <feGaussianBlur stdDeviation="2" result="blur"/>
                            <feComposite in="SourceGraphic" in2="blur" operator="over"/>
                        </filter>
                    </defs>
                    <g id="layer-legs">${getPartSVG('legs', parts.legs.type, parts.legs.color)}</g>
                    <g id="layer-arms">${getPartSVG('arms', parts.arms.type, parts.arms.color)}</g>
                    <g id="layer-body">${getPartSVG('body', parts.body.type, parts.body.color)}</g>
                    <g id="layer-head">${getPartSVG('head', parts.head.type, parts.head.color)}</g>
                </svg>
            `;
            return svgContent;
        }

        function adjustColor(hex, amount) {
            return '#' + hex.replace(/^#/, '').replace(/../g, color => ('0' + Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
        }

        // --- GAME ENGINE ---

        const game = {
            state: 'title', 
            
            player: {
                parts: {
                    head: PARTS.head[0],
                    body: PARTS.body[0],
                    arms: PARTS.arms[0],
                    legs: PARTS.legs[0]
                },
                stats: { hp: 0, maxHp: 0, atk: 0, spd: 0 },
                currentHp: 0,
                charge: 0
            },
            
            enemy: {
                parts: {},
                stats: {},
                currentHp: 0
            },

            currentTab: 'head',
            isPlayerTurn: true,
            turnInProgress: false,

            // Timing Game State
            timingInterval: null,
            timingCursorPos: 0,
            timingDirection: 1,

            // Methods
            init() {
                this.renderTitleRobot();
                this.initLiff(); // LIFFÂàùÊúüÂåñ„ÇíÈñãÂßã
            },

            // LIFFÈÄ£Êê∫Áî®„ÅÆÈñ¢Êï∞„ÇíËøΩÂä†
            async initLiff() {
                try {
                    // ‚Üì„Åì„Åì„Å´LINE Developers„ÅßÂèñÂæó„Åó„Åü„ÅÇ„Å™„Åü„ÅÆLIFF ID„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ
                    const myLiffId = "YOUR_LIFF_ID_HERE"; 
                    
                    if (!myLiffId || myLiffId === "YOUR_LIFF_ID_HERE") {
                        console.log("LIFF ID„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì");
                        return;
                    }

                    await liff.init({ liffId: myLiffId });

                    if (liff.isLoggedIn()) {
                        const profile = await liff.getProfile();
                        // „Éó„É¨„Ç§„É§„ÉºÂêç„ÇíLINE„ÅÆÂêçÂâç„Å´Â§âÊõ¥
                        const nameElements = document.querySelectorAll('.text-cyan-400.font-bold');
                        if(nameElements.length > 0) {
                            // „Äå„ÅÇ„Å™„Åü„Äç„Å®Êõ∏„Åã„Çå„Å¶„ÅÑ„ÇãÈÉ®ÂàÜ„ÇíÊé¢„Åó„Å¶Êõ∏„ÅçÊèõ„Åà
                            nameElements.forEach(el => {
                                if(el.innerText.includes('„ÅÇ„Å™„Åü')) {
                                    el.innerText = profile.displayName;
                                }
                            });
                        }
                        console.log("Logged in as:", profile.displayName);
                    } else {
                        // Êú™„É≠„Ç∞„Ç§„É≥„ÅÆÂ†¥Âêà„ÅØ„É≠„Ç∞„Ç§„É≥„Çí‰øÉ„Åô„Åì„Å®„ÇÇÂèØËÉΩ„Åß„Åô„Åå„ÄÅ
                        // LINE„Ç¢„Éó„É™ÂÜÖ„ÅßÈñã„ÅèÂ†¥Âêà„ÅØÈÄöÂ∏∏Ëá™Âãï„Åß„É≠„Ç∞„Ç§„É≥„Åï„Çå„Åæ„Åô„ÄÇ
                    }
                } catch (err) {
                    console.error("LIFF Initialization failed", err);
                }
            },

            renderTitleRobot() {
                const randomParts = {
                    head: PARTS.head[Math.floor(Math.random() * PARTS.head.length)],
                    body: PARTS.body[Math.floor(Math.random() * PARTS.body.length)],
                    arms: PARTS.arms[Math.floor(Math.random() * PARTS.arms.length)],
                    legs: PARTS.legs[Math.floor(Math.random() * PARTS.legs.length)]
                };
                document.getElementById('title-robot').innerHTML = renderRobotSVG(randomParts);
            },

            goToBuild() {
                this.state = 'build';
                document.getElementById('screen-title').classList.add('hidden');
                document.getElementById('screen-build').classList.remove('hidden');
                document.getElementById('screen-build').classList.add('flex');
                this.updateBuildUI();
            },

            setTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.dataset.tab === tab) {
                        btn.classList.add('text-cyan-400', 'border-b-2', 'border-cyan-400');
                        btn.classList.remove('text-slate-400');
                    } else {
                        btn.classList.remove('text-cyan-400', 'border-b-2', 'border-cyan-400');
                        btn.classList.add('text-slate-400');
                    }
                });
                this.renderPartsGrid();
            },

            renderPartsGrid() {
                const container = document.getElementById('parts-grid');
                container.innerHTML = '';

                PARTS[this.currentTab].forEach(part => {
                    const isSelected = this.player.parts[this.currentTab].id === part.id;
                    const card = document.createElement('div');
                    card.className = `p-2 rounded-xl cursor-pointer transition-all border-2 ${isSelected ? 'bg-slate-800 border-cyan-400 scale-[1.02] shadow-[0_0_10px_rgba(34,211,238,0.3)]' : 'bg-slate-800/50 border-slate-700 hover:border-slate-500'}`;
                    
                    let typeDisplay = '';
                    if(part.atk > 10) typeDisplay = '<span class="text-red-400 text-xs">ATK UP</span>';
                    else if(part.hp > 30) typeDisplay = '<span class="text-green-400 text-xs">HP UP</span>';
                    else if(part.spd > 10) typeDisplay = '<span class="text-yellow-400 text-xs">SPD UP</span>';
                    else typeDisplay = '<span class="text-blue-400 text-xs">BALANCED</span>';

                    card.innerHTML = `
                        <div class="h-16 mb-2 bg-slate-900/50 rounded-lg flex items-center justify-center relative overflow-hidden">
                            <div class="scale-50 transform origin-center">
                                <svg viewBox="0 0 200 200" width="100" height="100">
                                    ${getPartSVG(this.currentTab, part.type, part.color)}
                                </svg>
                            </div>
                        </div>
                        <div class="font-bold text-sm text-white truncate">${part.name}</div>
                        <div class="flex justify-between items-center mt-1">
                            ${typeDisplay}
                        </div>
                    `;
                    card.onclick = () => {
                        this.player.parts[this.currentTab] = part;
                        this.updateBuildUI();
                        this.renderPartsGrid();
                    };
                    container.appendChild(card);
                });
            },

            updateBuildUI() {
                document.getElementById('build-preview').innerHTML = renderRobotSVG(this.player.parts);
                let hp = 0, atk = 0, spd = 0;
                Object.values(this.player.parts).forEach(p => {
                    hp += p.hp;
                    atk += p.atk;
                    spd += p.spd;
                });
                this.player.stats = { hp, maxHp: hp, atk, spd };
                document.getElementById('stat-hp-val').innerText = hp;
                document.getElementById('stat-atk-val').innerText = atk;
                document.getElementById('stat-spd-val').innerText = spd;
                if(document.getElementById('parts-grid').children.length === 0) this.renderPartsGrid();
            },

            generateEnemy() {
                const eParts = {
                    head: PARTS.head[Math.floor(Math.random() * PARTS.head.length)],
                    body: PARTS.body[Math.floor(Math.random() * PARTS.body.length)],
                    arms: PARTS.arms[Math.floor(Math.random() * PARTS.arms.length)],
                    legs: PARTS.legs[Math.floor(Math.random() * PARTS.legs.length)]
                };
                let hp = 0, atk = 0, spd = 0;
                Object.values(eParts).forEach(p => { hp += p.hp; atk += p.atk; spd += p.spd; });
                hp = Math.floor(hp * (0.9 + Math.random() * 0.4));
                this.enemy = { parts: eParts, stats: { hp, maxHp: hp, atk, spd }, currentHp: hp };
            },

            startBattle() {
                this.generateEnemy();
                this.player.currentHp = this.player.stats.maxHp;
                this.player.charge = 0;
                this.updateChargeUI();

                document.getElementById('screen-build').classList.add('hidden');
                document.getElementById('screen-build').classList.remove('flex');
                document.getElementById('screen-battle').classList.remove('hidden');
                document.getElementById('screen-battle').classList.add('flex');

                document.getElementById('battle-player-robot').innerHTML = renderRobotSVG(this.player.parts);
                document.getElementById('battle-enemy-robot').innerHTML = renderRobotSVG(this.enemy.parts);

                this.updateBattleBars();
                this.log("„Éê„Éà„É´„ÄÅ„Çπ„Çø„Éº„ÉàÔºÅ");

                this.turnInProgress = false;
                this.isPlayerTurn = this.player.stats.spd >= this.enemy.stats.spd;
                
                if (!this.isPlayerTurn) {
                    this.log("Êïµ„ÅÆÂÖàÂà∂ÊîªÊíÉÔºÅ");
                    setTimeout(() => this.enemyTurn(), 1500);
                } else {
                    this.log("„ÅÇ„Å™„Åü„ÅÆ„Çø„Éº„É≥ÔºÅ");
                }
                this.toggleButtons(this.isPlayerTurn);
            },

            updateBattleBars() {
                const pPct = Math.max(0, (this.player.currentHp / this.player.stats.maxHp) * 100);
                const ePct = Math.max(0, (this.enemy.currentHp / this.enemy.stats.maxHp) * 100);
                document.getElementById('battle-hp-player').style.width = `${pPct}%`;
                document.getElementById('battle-hp-enemy').style.width = `${ePct}%`;
                document.getElementById('hp-text-player').innerText = Math.max(0, this.player.currentHp);
                document.getElementById('hp-text-enemy').innerText = Math.max(0, this.enemy.currentHp);
            },

            updateChargeUI() {
                document.getElementById('special-charge').innerText = this.player.charge;
                const btn = document.getElementById('btn-special');
                if (this.player.charge >= 3) {
                    btn.disabled = false;
                    btn.classList.add('animate-pulse');
                    btn.classList.remove('grayscale');
                } else {
                    btn.disabled = true;
                    btn.classList.remove('animate-pulse');
                    btn.classList.add('grayscale');
                }
            },

            toggleButtons(enabled) {
                const btns = document.querySelectorAll('.battle-btn');
                btns.forEach(b => {
                    if (b.id === 'btn-special' && this.player.charge < 3) return;
                    b.disabled = !enabled;
                    if(!enabled) b.classList.add('opacity-50');
                    else b.classList.remove('opacity-50');
                });
            },

            log(msg) {
                const el = document.getElementById('battle-log');
                el.innerText = msg;
                el.style.opacity = 1;
            },

            showDamage(targetId, amount, type = 'normal') {
                const parent = document.getElementById(targetId === 'player' ? 'battle-player-pos' : 'battle-enemy-pos');
                const div = document.createElement('div');
                div.className = 'damage-popup';
                div.innerText = amount;
                
                if(type === 'crit') {
                    div.style.color = '#fbbf24';
                    div.style.fontSize = '3.5rem';
                    div.innerText = amount + '!';
                } else if (type === 'miss') {
                    div.style.color = '#94a3b8';
                    div.style.fontSize = '1.5rem';
                    div.innerText = 'MISS';
                } else if (type === 'heal') {
                    div.style.color = '#4ade80';
                    div.innerText = '+' + amount;
                }

                div.style.left = '50%';
                div.style.top = '20%';
                div.style.transform = 'translateX(-50%)';
                parent.appendChild(div);
                
                setTimeout(() => div.remove(), 1000);
                if (type !== 'miss' && type !== 'heal') {
                    const robot = parent.querySelector('div');
                    robot.classList.add('shake');
                    setTimeout(() => robot.classList.remove('shake'), 500);
                }
            },

            checkWinCondition() {
                if (this.enemy.currentHp <= 0) {
                    setTimeout(() => this.endGame(true), 1000);
                    return true;
                }
                if (this.player.currentHp <= 0) {
                    setTimeout(() => this.endGame(false), 1000);
                    return true;
                }
                return false;
            },

            // --- TIMING MINIGAME ---

            initiateAttack() {
                if (this.turnInProgress) return;
                this.turnInProgress = true;
                this.toggleButtons(false);
                
                // Show Timing Overlay
                document.getElementById('timing-overlay').classList.remove('hidden');
                const cursor = document.getElementById('timing-cursor');
                
                // Adjust difficulty based on SPD: Higher SPD = Slower Cursor
                let speed = 1.5 - (this.player.stats.spd * 0.02); 
                if (speed < 0.5) speed = 0.5;
                
                cursor.style.animationDuration = `${speed}s`;
                cursor.classList.add('cursor-running');
            },

            resolveTimingAttack() {
                const cursor = document.getElementById('timing-cursor');
                const bar = document.getElementById('timing-bar-container');
                
                // Get positions
                const barRect = bar.getBoundingClientRect();
                const cursorRect = cursor.getBoundingClientRect();
                
                // Calculate relative position (0 to 1)
                const center = cursorRect.left + (cursorRect.width / 2);
                const relativePos = (center - barRect.left) / barRect.width;
                
                // Stop Animation
                cursor.classList.remove('cursor-running');
                cursor.style.left = (relativePos * 100) + '%'; // Freeze visual
                
                // Hide overlay after short delay
                setTimeout(() => {
                    document.getElementById('timing-overlay').classList.add('hidden');
                    // Reset cursor for next time
                    cursor.style.left = '0%';
                    
                    this.performPlayerAttack(relativePos);
                }, 600);
            },

            performPlayerAttack(pos) {
                let damageMult = 0.5;
                let type = 'normal';
                
                // Sweet Spot: 0.45 to 0.55 (Center 10%)
                // Good Spot: 0.25 to 0.75 (Middle 50%)
                
                if (pos >= 0.45 && pos <= 0.55) {
                    damageMult = 1.5; // Critical
                    type = 'crit';
                    this.log("„ÇØ„É™„ÉÜ„Ç£„Ç´„É´„Éí„ÉÉ„ÉàÔºÅÔºÅ");
                } else if (pos >= 0.25 && pos <= 0.75) {
                    damageMult = 1.0; // Normal
                    this.log("„Ç¢„Çø„ÉÉ„ÇØÔºÅ");
                } else {
                    damageMult = 0.5; // Glancing blow
                    type = 'miss'; // Actually weak hit, but lets call it weak
                    this.log("„ÅÇ„Åü„Çä„ÅåÊµÖ„ÅÑÔºÅ");
                }

                const damage = Math.floor(this.player.stats.atk * damageMult);
                const animClass = 'attack-anim';

                document.getElementById('battle-player-pos').classList.add(animClass);
                
                setTimeout(() => {
                    document.getElementById('battle-player-pos').classList.remove(animClass);
                    this.enemy.currentHp -= damage;
                    this.showDamage('enemy', damage, type);
                    this.updateBattleBars();
                    
                    // Charge Special (Bonus for Critical)
                    if(this.player.charge < 3) {
                        this.player.charge++;
                        if(type === 'crit' && this.player.charge < 3) this.player.charge++; // Extra charge on crit
                    }
                    this.updateChargeUI();

                    if (!this.checkWinCondition()) {
                        setTimeout(() => this.enemyTurn(), 1500);
                    }
                }, 400);
            },

            // --- OTHER ACTIONS ---

            playerAction(action) {
                if (this.turnInProgress) return;
                this.turnInProgress = true;
                this.toggleButtons(false);

                if (action === 'repair') {
                    const heal = Math.floor(this.player.stats.maxHp * 0.3);
                    this.player.currentHp = Math.min(this.player.stats.maxHp, this.player.currentHp + heal);
                    this.log(`‰øÆÁêÜ‰∏≠...`);
                    this.updateBattleBars();
                    this.showDamage('player', heal, 'heal');
                    
                    const p = document.getElementById('battle-player-pos');
                    p.style.filter = "brightness(1.5) sepia(1) hue-rotate(90deg) saturate(5)";
                    setTimeout(() => p.style.filter = "", 500);
                    setTimeout(() => this.enemyTurn(), 1500);

                } else if (action === 'special') {
                    // Special is auto-hit, high damage
                    const damage = Math.floor(this.player.stats.atk * 3.0);
                    this.log("ÂøÖÊÆ∫ÊäÄÁô∫ÂãïÔºÅÔºÅ");
                    this.player.charge = 0;
                    this.updateChargeUI();
                    
                    document.getElementById('battle-player-pos').classList.add('attack-anim');
                     setTimeout(() => {
                        document.getElementById('battle-player-pos').classList.remove('attack-anim');
                        this.enemy.currentHp -= damage;
                        this.showDamage('enemy', damage, 'crit');
                        this.updateBattleBars();
                        if (!this.checkWinCondition()) {
                            setTimeout(() => this.enemyTurn(), 1500);
                        }
                    }, 400);
                }
            },

            enemyTurn() {
                this.log("Êïµ„ÅÆÊîªÊíÉ...");
                
                // Dodge Calculation
                // Chance = (Player SPD - Enemy SPD) * 2. Max 50%. Min 0%.
                let dodgeChance = (this.player.stats.spd - this.enemy.stats.spd) * 2;
                if (dodgeChance < 0) dodgeChance = 0;
                if (dodgeChance > 50) dodgeChance = 50;

                const isDodged = (Math.random() * 100) < dodgeChance;

                const animClass = 'enemy-attack-anim';
                document.getElementById('battle-enemy-pos').classList.add(animClass);

                setTimeout(() => {
                    document.getElementById('battle-enemy-pos').classList.remove(animClass);
                    
                    if (isDodged) {
                        this.log("ÊîªÊíÉ„Çí„Çà„Åë„ÅüÔºÅ");
                        document.getElementById('battle-player-pos').classList.add('dodge-anim');
                        this.showDamage('player', 0, 'miss');
                        setTimeout(() => document.getElementById('battle-player-pos').classList.remove('dodge-anim'), 500);
                    } else {
                        const damage = Math.floor(this.enemy.stats.atk * (0.8 + Math.random() * 0.4));
                        this.player.currentHp -= damage;
                        this.showDamage('player', damage);
                        this.updateBattleBars();
                    }

                    if (!this.checkWinCondition()) {
                        this.isPlayerTurn = true;
                        this.turnInProgress = false;
                        this.log("„ÅÇ„Å™„Åü„ÅÆ„Çø„Éº„É≥ÔºÅ");
                        this.toggleButtons(true);
                    }
                }, 400);
            },

            endGame(win) {
                const screen = document.getElementById('screen-result');
                const title = document.getElementById('result-title');
                const msg = document.getElementById('result-message');
                screen.classList.remove('hidden');
                screen.classList.add('flex');

                if (win) {
                    title.innerText = "YOU WIN!";
                    title.className = "text-6xl font-black text-yellow-400 mb-4 title-font drop-shadow-lg";
                    msg.innerText = "ÊúÄÂº∑„ÅÆ„É≠„Éú„ÉÉ„Éà„Å†ÔºÅ";
                } else {
                    title.innerText = "LOSE...";
                    title.className = "text-6xl font-black text-slate-400 mb-4 title-font drop-shadow-lg";
                    msg.innerText = "Ê¨°„ÅØ„ÇÇ„Å£„Å®Âº∑„ÅÑ„Éë„Éº„ÉÑ„ÇíÈÅ∏„Åº„ÅÜ...";
                }
            },

            resetGame() {
                document.getElementById('screen-result').classList.add('hidden');
                document.getElementById('screen-result').classList.remove('flex');
                document.getElementById('screen-battle').classList.add('hidden');
                document.getElementById('screen-battle').classList.remove('flex');
                this.goToBuild();
            }
        };

        window.onload = () => game.init();

    </script>
</body>
</html>
