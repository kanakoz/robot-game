import React, { useState, useEffect, useRef } from 'react';
import { Check, Star, RefreshCw, Trophy, BookOpen, Search, MapPin, Users, School, Share2, MessageCircle, Sparkles, X, ArrowRight, Lightbulb, Edit3 } from 'lucide-react';

const App = () => {
  // =================================================================
  // ã€è¨­å®šç®‡æ‰€ã€‘ã“ã“ã«ã‚ãªãŸã®LIFF IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
  // ä¾‹: "1234567890-abcdefgh"
  const LIFF_ID = "2008547267-ropNDWQn"; 
  // =================================================================

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®çŠ¶æ…‹ç®¡ç†
  const [userName, setUserName] = useState("ã‚­ãƒŸ");
  const [isEditingName, setIsEditingName] = useState(false);
  const nameInputRef = useRef(null);
  const [liffError, setLiffError] = useState(null);

  // LIFFã®åˆæœŸåŒ–å‡¦ç†
  useEffect(() => {
    const initializeLiff = async () => {
      // LIFF IDãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰
      if (!LIFF_ID) return;

      try {
        // LIFF SDKã‚’å‹•çš„ã«ãƒ­ãƒ¼ãƒ‰
        if (!window.liff) {
          const script = document.createElement('script');
          script.src = 'https://static.line-scdn.net/liff/edge/2/sdk.js';
          script.async = true;
          document.body.appendChild(script);
          
          script.onload = async () => {
            await initLiffSDK();
          };
        } else {
          await initLiffSDK();
        }
      } catch (error) {
        console.error('LIFF initialization error:', error);
        setLiffError('LIFFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };

    const initLiffSDK = async () => {
      try {
        await window.liff.init({ liffId: LIFF_ID });
        
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
        if (window.liff.isLoggedIn()) {
          const profile = await window.liff.getProfile();
          setUserName(profile.displayName); // LINEã®åå‰ã‚’ã‚»ãƒƒãƒˆ
        } else {
          // æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆã€å¿…è¦ã§ã‚ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ã‚’ä¿ƒã™
          // window.liff.login(); 
        }
      } catch (error) {
        console.error('LIFF init failed:', error);
      }
    };

    initializeLiff();
  }, []);


  // ã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹ç®¡ç†
  const [tasks, setTasks] = useState([
    { 
      id: 1, 
      text: "é€²å­¦ã™ã‚‹ç›®çš„ã‚’æ˜ç¢ºã«ã™ã‚‹", 
      subtext: "ãªãœé€²å­¦ã™ã‚‹ã®ï¼Ÿå°†æ¥ã©ã†ãªã‚ŠãŸã„ï¼Ÿ", 
      icon: <BookOpen className="w-5 h-5 text-indigo-500" />,
      completed: false,
      hasDiagnosis: true // è¨ºæ–­æ©Ÿèƒ½ã‚’æŒã¤ãƒ•ãƒ©ã‚°
    },
    { 
      id: 2, 
      text: "æ±ºã‚ãŸç›®çš„ã®é”æˆæ–¹æ³•ã‚’èª¿ã¹ã‚‹", 
      subtext: "ã©ã®å­¦éƒ¨ï¼Ÿã©ã‚“ãªè³‡æ ¼ãŒå¿…è¦ï¼Ÿ", 
      icon: <Search className="w-5 h-5 text-pink-500" />,
      completed: false 
    },
    { 
      id: 3, 
      text: "ç›®çš„ã«ãƒ”ãƒƒã‚¿ãƒªãªé€²è·¯ãƒ»å­¦æ ¡ã‚’é¸ã¶", 
      subtext: "è‡ªåˆ†ã«åˆã†å­¦æ ¡ã‚’ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼", 
      icon: <MapPin className="w-5 h-5 text-cyan-500" />,
      completed: false 
    },
    { 
      id: 4, 
      text: "ä¿è­·è€…ã‚„å…ˆç”Ÿã«ãƒ—ãƒ¬ã‚¼ãƒ³ã™ã‚‹", 
      subtext: "è‡ªåˆ†ã®ç†±æ„ã‚’ä¼ãˆã‚ˆã†ï¼", 
      icon: <Users className="w-5 h-5 text-orange-500" />,
      completed: false 
    },
    { 
      id: 5, 
      text: "è¦‹å­¦ãƒ»è³‡æ–™è«‹æ±‚ã‚’ã™ã‚‹", 
      subtext: "å®Ÿéš›ã®é›°å›²æ°—ã‚’æ„Ÿã˜ã¦è©³ã—ããªã‚ã†", 
      icon: <School className="w-5 h-5 text-emerald-500" />,
      completed: false 
    },
  ]);

  const [showConfetti, setShowConfetti] = useState(false);
  
  // è¨ºæ–­æ©Ÿèƒ½ç”¨ã®State
  const [isDiagnosisOpen, setIsDiagnosisOpen] = useState(false);
  const [diagnosisStep, setDiagnosisStep] = useState(0); // 0: start, 1-3: questions, 4: result
  const [diagnosisScores, setDiagnosisScores] = useState({ A: 0, B: 0 });
  const [diagnosisResult, setDiagnosisResult] = useState(null);

  // è¨ºæ–­ãƒ‡ãƒ¼ã‚¿
  const diagnosisQuestions = [
    {
      id: 1,
      text: "å¥½ããªæˆæ¥­ã‚„æ´»å‹•ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ï¼Ÿ",
      options: [
        { text: "èˆˆå‘³ã®ã‚ã‚‹åˆ†é‡ã‚’ã¨ã“ã¨ã‚“æ·±æ˜ã‚Šã—ãŸã„", type: 'A' },
        { text: "è‰²ã€…ãªçŸ¥è­˜ã‚’åºƒãèº«ã«ã¤ã‘ãŸã„", type: 'B' }
      ]
    },
    {
      id: 2,
      text: "å°†æ¥ã®ä»•äº‹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ï¼Ÿ",
      options: [
        { text: "å°‚é–€ã‚¹ã‚­ãƒ«ã‚’æ´»ã‹ã™ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«", type: 'A' },
        { text: "ãƒãƒ¼ãƒ ã‚’ã¾ã¨ã‚ãŸã‚Šä¼ç”»ã‚’ã™ã‚‹ä»•äº‹", type: 'B' }
      ]
    },
    {
      id: 3,
      text: "å­¦æ ¡ç”Ÿæ´»ã§é‡è¦–ã—ãŸã„ã®ã¯ï¼Ÿ",
      options: [
        { text: "è³‡æ ¼å–å¾—ã‚„å®Ÿç¿’ãªã©ã®ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ", type: 'A' },
        { text: "ã‚µãƒ¼ã‚¯ãƒ«ã‚„ã‚¤ãƒ™ãƒ³ãƒˆãªã©ã®äººã¨ã®å‡ºä¼šã„", type: 'B' }
      ]
    }
  ];

  // è¨ºæ–­çµæœãƒ‡ãƒ¼ã‚¿
  const diagnosisResults = {
    specialist: {
      title: "ã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆæ¢æ±‚ã‚¿ã‚¤ãƒ—",
      desc: "ã‚ãªãŸã¯ç‰¹å®šã®åˆ†é‡ã§ãƒ—ãƒ­ã‚’ç›®æŒ‡ã™ã®ãŒå‘ã„ã¦ã„ã‚‹ã‹ã‚‚ï¼",
      objective: "ã€Œå°‚é–€çš„ãªã‚¹ã‚­ãƒ«ã‚’èº«ã«ã¤ã‘ã€å°†æ¥ã€‡ã€‡ã®ãƒ—ãƒ­ã¨ã—ã¦æ´»èºã™ã‚‹ãŸã‚ã€",
      color: "bg-indigo-100 text-indigo-800 border-indigo-200"
    },
    generalist: {
      title: "å¯èƒ½æ€§åºƒãŒã‚‹ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼ã‚¿ã‚¤ãƒ—",
      desc: "ã‚ãªãŸã¯å¤§å­¦ãªã©ã§åºƒã„æ•™é¤Šã‚„çµŒé¨“ã‚’ç©ã‚€ã®ãŒãŠã™ã™ã‚ï¼",
      objective: "ã€Œå¹…åºƒã„æ•™é¤Šã¨çµŒé¨“ã‚’ç©ã¿ã€å°†æ¥ã‚„ã‚ŠãŸã„ã“ã¨ã‚’æ˜ç¢ºã«ã™ã‚‹ãŸã‚ã€",
      color: "bg-orange-100 text-orange-800 border-orange-200"
    }
  };

  // å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
  const completedCount = tasks.filter(t => t.completed).length;
  const progress = (completedCount / tasks.length) * 100;

  // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å®šç¾©
  const getCharacter = (count) => {
    if (count === 0) return { 
      emoji: "ğŸ¥š", 
      name: "ãƒŸãƒ©ã‚¤ã®ãŸã¾ã”", 
      desc: "ã¾ã ä½•ã‚‚å§‹ã¾ã£ã¦ã„ãªã„ç´”ç™½ã®ãŸã¾ã”ã€‚\nå›ã®å¯èƒ½æ€§ãŒè©°ã¾ã£ã¦ã‚‹ï¼",
      color: "bg-gray-100",
      borderColor: "border-gray-200"
    };
    if (count <= 1) return { 
      emoji: "ğŸ£", 
      name: "ãƒ’ãƒ¨ãƒƒå­", 
      desc: "æ®»ã‚’ç ´ã£ã¦å°‘ã—ä¸–ç•ŒãŒè¦‹ãˆãŸï¼\nã¾ãšã¯ç›®çš„ã‚’ã—ã£ã‹ã‚Šè¦‹æ®ãˆã‚ˆã†ã€‚",
      color: "bg-yellow-50",
      borderColor: "border-yellow-200"
    };
    if (count <= 2) return { 
      emoji: "ğŸ¥", 
      name: "ãƒˆã‚³ãƒˆã‚³ãƒ»ãƒãƒ¼ãƒ‰", 
      desc: "è‡ªåˆ†ã®è¶³ã§èª¿ã¹å§‹ã‚ãŸã­ã€‚\næƒ…å ±åé›†ãŒå¾—æ„ã«ãªã£ã¦ããŸï¼",
      color: "bg-green-50",
      borderColor: "border-green-200"
    };
    if (count <= 3) return { 
      emoji: "ğŸ¦‰", 
      name: "ã‚¤ãƒ³ãƒ†ãƒªãƒ»ãƒ•ã‚¯ãƒ­ã‚¦", 
      desc: "è³¢ã„é¸æŠãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚\nè‡ªåˆ†ã«åˆã†å ´æ‰€ãŒè¦‹ãˆã¦ããŸã¯ãšã€‚",
      color: "bg-blue-50",
      borderColor: "border-blue-200"
    };
    if (count <= 4) return { 
      emoji: "ğŸ¦…", 
      name: "ã‚«ã‚¯ã‚·ãƒ³ãƒ»ãƒ›ãƒ¼ã‚¯", 
      desc: "è‡ªä¿¡ã‚’æŒã£ã¦ä»–äººã«èª¬æ˜ã§ãã‚‹å¼·ã•ã‚’æŒã£ãŸï¼\nã‚ã¨ä¸€æ­©ï¼",
      color: "bg-purple-50",
      borderColor: "border-purple-200"
    };
    return { 
      emoji: "ğŸ¦„", 
      name: "ãƒ‰ãƒªãƒ¼ãƒ ãƒ»ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³", 
      desc: "ãŠã‚ã§ã¨ã†ï¼å›ã®é€²è·¯ã¯è¼ã„ã¦ã„ã‚‹ï¼\nã“ã®èª¿å­ã§æœªæ¥ã¸çªãé€²ã‚‚ã†ï¼",
      color: "bg-gradient-to-br from-pink-100 via-purple-100 to-indigo-100",
      borderColor: "border-pink-300"
    };
  };

  const character = getCharacter(completedCount);

  // ã‚¿ã‚¹ã‚¯ã®åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
  const toggleTask = (id) => {
    const newTasks = tasks.map(task => 
      task.id === id ? { ...task, completed: !task.completed } : task
    );
    setTasks(newTasks);
  };

  // è¨ºæ–­ã‚’é–‹ã
  const openDiagnosis = (e) => {
    e.stopPropagation(); // è¦ªè¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¿ã‚¹ã‚¯å®Œäº†ï¼‰ã‚’é˜»æ­¢
    setIsDiagnosisOpen(true);
    setDiagnosisStep(0);
    setDiagnosisScores({ A: 0, B: 0 });
  };

  // è¨ºæ–­ã®å›ç­”å‡¦ç†
  const handleAnswer = (type) => {
    const newScores = { ...diagnosisScores, [type]: diagnosisScores[type] + 1 };
    setDiagnosisScores(newScores);

    if (diagnosisStep < diagnosisQuestions.length) {
      setDiagnosisStep(diagnosisStep + 1);
    } else {
      // çµæœåˆ¤å®š
      const result = newScores.A > newScores.B ? diagnosisResults.specialist : diagnosisResults.generalist;
      setDiagnosisResult(result);
      setDiagnosisStep(4); // çµæœç”»é¢ã¸
    }
  };

  // å…¨é”æˆæ™‚ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  useEffect(() => {
    if (completedCount === tasks.length) {
      setShowConfetti(true);
    } else {
      setShowConfetti(false);
    }
  }, [completedCount]);

  // åå‰ã®ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹æ™‚ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  useEffect(() => {
    if (isEditingName && nameInputRef.current) {
      nameInputRef.current.focus();
    }
  }, [isEditingName]);

  const handleNameSubmit = (e) => {
    e.preventDefault();
    if (userName.trim() === "") setUserName("ã‚­ãƒŸ");
    setIsEditingName(false);
  };

  // ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
  const resetApp = () => {
    if (confirm("é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ")) {
      setTasks(tasks.map(t => ({ ...t, completed: false })));
      setShowConfetti(false);
    }
  };

  // LINEã§ã‚·ã‚§ã‚¢ã™ã‚‹æ©Ÿèƒ½
  const shareToLine = () => {
    const text = `${userName}ã®é€²è·¯ã‚¯ã‚¨ã‚¹ãƒˆé€²è¡Œä¸­ï¼\nç¾åœ¨ã®ã‚­ãƒ£ãƒ©: ${character.name} ${character.emoji}\né€²æ—ç‡: ${Math.round(progress)}%\n\n#SHINRO_QUEST`;
    // LIFFç’°å¢ƒä¸‹ãªã‚‰liff.shareTargetPickerã‚’ä½¿ã†ã®ãŒç†æƒ³ã§ã™ãŒã€ã“ã“ã§ã¯æ±ç”¨çš„ãªURLã‚¹ã‚­ãƒ¼ãƒ ã‚’ä½¿ç”¨
    if (window.liff && window.liff.isLoggedIn() && window.liff.isInClient()) {
        // LIFFãƒ–ãƒ©ã‚¦ã‚¶å†…ã§é–‹ã„ã¦ã„ã‚‹å ´åˆã€shareTargetPickerã‚’ä½¿ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
        // window.liff.shareTargetPicker(...)
        // ä»Šå›ã¯ç°¡æ˜“çš„ã«URLã‚¹ã‚­ãƒ¼ãƒ ã§
    }
    const url = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
    window.open(url, '_blank');
  };

  return (
    <div className="min-h-[100dvh] bg-slate-50 font-sans text-slate-800 pb-24">
      
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ */}
      <header className="pt-6 pb-4 px-6 text-center sticky top-0 z-10 bg-slate-50/90 backdrop-blur-sm">
        <div className="flex flex-col items-center justify-center gap-1">
          <div className="flex items-center gap-2">
            {isEditingName ? (
              <form onSubmit={handleNameSubmit} className="flex items-center">
                <input 
                  ref={nameInputRef}
                  type="text" 
                  value={userName}
                  onChange={(e) => setUserName(e.target.value)}
                  onBlur={() => setIsEditingName(false)}
                  className="text-lg font-black text-center bg-white border-b-2 border-purple-500 outline-none w-32 rounded px-1"
                  maxLength={10}
                />
              </form>
            ) : (
              <h1 className="text-xl font-black tracking-wider text-slate-800 flex items-center gap-2" onClick={() => setIsEditingName(true)}>
                {userName}ã®ã‚¯ã‚¨ã‚¹ãƒˆ
                <Edit3 className="w-4 h-4 text-slate-400 cursor-pointer hover:text-purple-500" />
              </h1>
            )}
          </div>
          <span className="text-[10px] text-slate-400 font-bold tracking-widest">SHINRO QUEST</span>
        </div>
        <div className="h-1 w-12 bg-gradient-to-r from-purple-500 to-pink-500 mx-auto rounded-full mt-2"></div>
      </header>

      <main className="px-4 max-w-md mx-auto space-y-6">
        
        {/* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ãƒ‰ */}
        <div className={`relative w-full rounded-3xl shadow-sm transition-all duration-500 border-2 ${character.borderColor} ${character.color} p-6 overflow-hidden`}>
          <div className="flex flex-col items-center text-center relative z-10">
            <div className={`text-8xl mb-4 filter drop-shadow-md transition-transform duration-500 transform ${showConfetti ? 'animate-bounce scale-110' : ''}`}>
              {character.emoji}
            </div>
            <div className="inline-block px-3 py-1 rounded-full bg-white/60 backdrop-blur-sm text-xs font-bold text-slate-500 mb-2 border border-white/50">
              LV.{completedCount} / 5
            </div>
            <h2 className="text-xl font-bold text-slate-800 mb-2">{character.name}</h2>
            <p className="text-sm text-slate-600 font-medium leading-relaxed whitespace-pre-wrap">
              {character.desc}
            </p>
          </div>
          <div className="mt-6 bg-white/50 rounded-full h-3 w-full overflow-hidden">
            <div 
              className="bg-gradient-to-r from-blue-400 to-purple-500 h-full rounded-full transition-all duration-1000 ease-out"
              style={{ width: `${progress}%` }}
            ></div>
          </div>
          {showConfetti && (
            <div className="absolute inset-0 pointer-events-none flex justify-center items-center overflow-hidden">
              <div className="animate-spin-slow text-6xl opacity-30 select-none">âœ¨</div>
            </div>
          )}
        </div>

        {/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ç¾¤ */}
        <div className="grid grid-cols-2 gap-3">
          <button 
            onClick={shareToLine}
            className="flex items-center justify-center gap-2 bg-[#06C755] hover:bg-[#05b34c] text-white font-bold py-3 px-4 rounded-xl transition-transform active:scale-95 shadow-sm"
          >
            <MessageCircle className="w-5 h-5" />
            <span className="text-sm">LINEã§å…±æœ‰</span>
          </button>
          <div className="bg-white rounded-xl border-2 border-slate-100 p-3 flex items-center justify-center text-center shadow-sm">
            <p className="text-xs text-slate-500 font-bold">
              æ¬¡ã®é€²åŒ–ã¾ã§<br/>ã‚ã¨ <span className="text-purple-600 text-base">{tasks.length - completedCount}</span> ã‚¯ã‚¨ã‚¹ãƒˆ
            </p>
          </div>
        </div>

        {/* ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ */}
        <div className="space-y-3">
          <div className="flex items-center justify-between px-2">
            <h3 className="text-sm font-bold text-slate-400 tracking-wider flex items-center gap-1">
              MISSION LIST
            </h3>
            {completedCount > 0 && (
               <button onClick={resetApp} className="text-xs text-slate-400 hover:text-slate-600 flex items-center gap-1">
                 <RefreshCw className="w-3 h-3" /> ãƒªã‚»ãƒƒãƒˆ
               </button>
            )}
          </div>
          
          {tasks.map((task) => (
            <div 
              key={task.id}
              onClick={() => toggleTask(task.id)}
              className={`group relative p-4 rounded-2xl transition-all duration-200 active:scale-[0.98] cursor-pointer
                ${task.completed 
                  ? 'bg-slate-100 border-2 border-transparent opacity-70' 
                  : 'bg-white border-2 border-slate-100 shadow-sm hover:border-purple-200'
                }`}
            >
              <div className="flex flex-col gap-3">
                <div className="flex items-center gap-4">
                  <div className={`flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center transition-colors
                    ${task.completed ? 'bg-slate-200 grayscale' : 'bg-slate-50'}`}>
                    {task.icon}
                  </div>
                  <div className="flex-1 min-w-0">
                    <h4 className={`font-bold text-sm mb-0.5 truncate ${task.completed ? 'text-slate-400 line-through' : 'text-slate-800'}`}>
                      {task.text}
                    </h4>
                    <p className={`text-xs truncate ${task.completed ? 'text-slate-300' : 'text-slate-500'}`}>
                      {task.subtext}
                    </p>
                  </div>
                  <div className={`flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all
                    ${task.completed ? 'bg-[#06C755] border-[#06C755]' : 'bg-white border-slate-200'}`}>
                    {task.completed && <Check className="w-3.5 h-3.5 text-white" strokeWidth={4} />}
                  </div>
                </div>

                {/* è¨ºæ–­ãƒœã‚¿ãƒ³ï¼ˆã‚¿ã‚¹ã‚¯1ã®ã¿ã«è¡¨ç¤ºãƒ»æœªå®Œäº†æ™‚ã®ã¿æ¨å¥¨ï¼‰ */}
                {task.hasDiagnosis && !task.completed && (
                  <div className="pl-14">
                    <button 
                      onClick={openDiagnosis}
                      className="w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-600 text-xs font-bold py-2 px-3 rounded-lg flex items-center justify-center gap-2 transition-colors border border-indigo-100"
                    >
                      <Sparkles className="w-4 h-4 text-indigo-500" />
                      ç›®çš„ãŒæ±ºã¾ã‚‰ãªã„ï¼Ÿ è¨ºæ–­ã§ãƒ’ãƒ³ãƒˆã‚’ã‚‚ã‚‰ã†
                    </button>
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>
      </main>

      {/* è¨ºæ–­ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {isDiagnosisOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center px-4 bg-slate-900/60 backdrop-blur-sm animate-fade-in">
          <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative overflow-hidden">
            
            {/* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ */}
            <button 
              onClick={() => setIsDiagnosisOpen(false)}
              className="absolute top-4 right-4 text-slate-400 hover:text-slate-600 p-1 bg-slate-100 rounded-full"
            >
              <X className="w-5 h-5" />
            </button>

            {/* ã‚¹ãƒ†ãƒƒãƒ—0: ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */}
            {diagnosisStep === 0 && (
              <div className="text-center py-6">
                <div className="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce">
                  <Lightbulb className="w-10 h-10 text-indigo-500" />
                </div>
                <h3 className="text-xl font-black text-slate-800 mb-3">é€²å­¦ç›®çš„ è¨ºæ–­</h3>
                <p className="text-slate-600 text-sm mb-8 leading-relaxed">
                  ã€Œãªã‚“ã¨ãªãé€²å­¦ã€ã‹ã‚‰å’æ¥­ï¼<br/>
                  ç°¡å˜ãª3ã¤ã®è³ªå•ã«ç­”ãˆã‚‹ã ã‘ã§ã€<br/>
                  ã‚ãªãŸã«åˆã£ãŸé€²å­¦ç›®çš„ã®ãƒ’ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã™ã€‚
                </p>
                <button 
                  onClick={() => setDiagnosisStep(1)}
                  className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 transition-all active:scale-95 flex items-center justify-center gap-2"
                >
                  è¨ºæ–­ã‚¹ã‚¿ãƒ¼ãƒˆ
                  <ArrowRight className="w-5 h-5" />
                </button>
              </div>
            )}

            {/* ã‚¹ãƒ†ãƒƒãƒ—1-3: è³ªå•ç”»é¢ */}
            {diagnosisStep >= 1 && diagnosisStep <= 3 && (
              <div className="py-4">
                <div className="text-center mb-6">
                  <span className="text-xs font-bold text-indigo-500 tracking-widest">QUESTION 0{diagnosisStep}</span>
                  <h3 className="text-lg font-bold text-slate-800 mt-2 h-14 flex items-center justify-center">
                    {diagnosisQuestions[diagnosisStep - 1].text}
                  </h3>
                </div>
                <div className="space-y-3">
                  {diagnosisQuestions[diagnosisStep - 1].options.map((option, idx) => (
                    <button
                      key={idx}
                      onClick={() => handleAnswer(option.type)}
                      className="w-full p-4 text-left rounded-xl border-2 border-slate-100 hover:border-indigo-400 hover:bg-indigo-50 transition-all active:scale-95 flex items-center justify-between group"
                    >
                      <span className="text-sm font-bold text-slate-700 group-hover:text-indigo-900">{option.text}</span>
                      <ArrowRight className="w-4 h-4 text-slate-300 group-hover:text-indigo-500" />
                    </button>
                  ))}
                </div>
                <div className="flex justify-center gap-2 mt-8">
                  {[1, 2, 3].map(dot => (
                    <div key={dot} className={`h-2 rounded-full transition-all duration-300 ${diagnosisStep === dot ? 'w-8 bg-indigo-500' : 'w-2 bg-slate-200'}`} />
                  ))}
                </div>
              </div>
            )}

            {/* ã‚¹ãƒ†ãƒƒãƒ—4: çµæœç”»é¢ */}
            {diagnosisStep === 4 && diagnosisResult && (
              <div className="text-center py-2 animate-fade-in-up">
                <p className="text-xs font-bold text-slate-400 mb-2">DIAGNOSIS RESULT</p>
                <h3 className="text-xl font-black text-slate-800 mb-4">
                  {diagnosisResult.title}
                </h3>
                
                <div className={`p-5 rounded-2xl border-2 mb-6 ${diagnosisResult.color} text-left`}>
                  <p className="text-sm font-bold mb-3 opacity-90">ğŸ’¡ ã‚ãªãŸã¸ã®ãƒ’ãƒ³ãƒˆ</p>
                  <p className="text-sm leading-relaxed mb-4 opacity-90">
                    {diagnosisResult.desc}
                  </p>
                  <div className="bg-white/60 p-3 rounded-lg">
                    <p className="text-xs font-bold mb-1 opacity-70">ç›®çš„ã®ä¾‹ï¼š</p>
                    <p className="font-bold text-base">
                      {diagnosisResult.objective}
                    </p>
                  </div>
                </div>

                <button 
                  onClick={() => setIsDiagnosisOpen(false)}
                  className="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all active:scale-95"
                >
                  ã“ã‚Œã§æ±ºå®šã™ã‚‹ï¼
                </button>
                <p className="text-xs text-slate-400 mt-4">
                  â€»ã‚¿ã‚¹ã‚¯ã®ãƒã‚§ãƒƒã‚¯ã¯æ‰‹å‹•ã§è¡Œã£ã¦ãã ã•ã„
                </p>
              </div>
            )}

          </div>
        </div>
      )}

      {/* å®Œäº†æ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */}
      {showConfetti && (
        <div className="fixed bottom-6 inset-x-0 px-4 pointer-events-none z-50 animate-bounce-in">
          <div className="bg-slate-800/90 backdrop-blur text-white p-4 rounded-2xl shadow-2xl flex items-center gap-4 border border-slate-700">
            <div className="bg-yellow-400 p-2 rounded-full text-slate-900">
              <Trophy className="w-6 h-6" />
            </div>
            <div>
              <p className="font-bold text-sm text-yellow-400">CONGRATULATIONS!</p>
              <p className="text-xs font-medium">ã™ã¹ã¦ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’é”æˆã—ã¾ã—ãŸï¼</p>
            </div>
            <button 
              onClick={shareToLine}
              className="ml-auto pointer-events-auto bg-[#06C755] hover:bg-[#05b34c] text-white px-4 py-2 rounded-lg text-xs font-bold transition-colors"
            >
              è‡ªæ…¢ã™ã‚‹
            </button>
          </div>
        </div>
      )}
      
    </div>
  );
};

export default App;
